<!DOCTYPE html>
<html lang="zh">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"> 
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>客运段人事管理系统</title>
	<link rel="stylesheet" href="../static/css/bootstrap.min.css" /> 
	<link rel="stylesheet" href="../static/css/bootstrap-table.css">
	<link rel="stylesheet" href="../static/css/bootstrap-select.css">
	<link rel="stylesheet" href="../static/css/bootstrap-datetimepicker.min.css" media="screen">
	<link rel="stylesheet" href="../static/css/style.css" /> 
	<link rel="stylesheet" href="../static/css/sidebar-menu.css">
	<link rel="stylesheet" href="http://cdn.bootcss.com/font-awesome/4.6.0/css/font-awesome.min.css">

</style>
  <!--[if IE]>
    <script src="http://libs.useso.com/js/html5shiv/3.7/html5shiv.min.js"></script>
<![endif]-->
</head>
<body>
	<nav class="navbar navbar-default navbar-fixed-top" role="navigation"> 
		<div class="container-fluid"> 
			<div class="navbar-header"> 
				<a class="navbar-brand" href="/">客运段人事管理系统</a> 
			</div> 
			<ul class="nav navbar-nav navbar-right"> 
				<!-- <li><a href="#"><span class="glyphicon glyphicon-user"></span> 注册</a></li>  -->
				<li><a href="#"><span class="glyphicon glyphicon-log-in"></span> 登录</a></li> 
			</ul> 
		</div> 
	</nav>
	<aside class="main-sidebar" >
		<section  class="sidebar">
			<ul class="sidebar-menu">
				<!-- <li class="header" style="color: white;font-size: 180%"><strong>人事管理系统</strong></li> -->
				<li class="treeview">
					<a href="#">
						<i class="fa fa-dashboard"></i> <span>人员管理</span> <i class="fa fa-angle-left pull-right"></i>
					</a>
					<ul class="treeview-menu">
						<li><a href="#"><i class="fa fa-circle-o"></i> 人员信息管理</a></li>
						<li><a href="#"><i class="fa fa-circle-o"></i> 人员信息浏览</a></li>
						<!-- <li><a href="#"><i class="fa fa-circle-o"></i> 人员信息浏览</a></li> -->
						<!-- <li><a href="#"><i class="fa fa-circle-o"></i> 人员列表查询</a></li> -->
						<li><a href="#"><i class="fa fa-circle-o"></i> 人员信息统计</a></li>
						<li><a href="#"><i class="fa fa-circle-o"></i> 人员变动管理</a></li>
					</ul>
				</li>
				<li class="treeview">
					<a href="#">
						<i class="fa fa-laptop"></i>
						<span>数据标准管理</span>
						<i class="fa fa-angle-left pull-right"></i>
					</a>
					<ul class="treeview-menu">
						<li><a href="/dict"><i class="fa fa-circle-o"></i> 数据字典管理</a></li>
						<li><a href="/org"><i class="fa fa-circle-o"></i> 组织机构管理</a></li>
					</ul>
				</li>
				<li class="treeview">
					<a href="#">
						<i class="fa fa-pie-chart"></i>
						<span>统计分析</span>
						<i class="fa fa-angle-left pull-right"></i>
					</a>
					<ul class="treeview-menu">
						<li><a href="#"><i class="fa fa-circle-o"></i> 人员变动统计</a></li>
					</ul>
				</li>
				<li class="treeview">
					<a href="#">
						<i class="fa fa-edit"></i> <span>系统管理</span>
						<i class="fa fa-angle-left pull-right"></i>
					</a>
					<ul class="treeview-menu">
						<li><a href="#"><i class="fa fa-circle-o"></i> 系统日志管理</a></li>
						<li><a href="#"><i class="fa fa-circle-o"></i> 登录用户管理</a></li>
					</ul>
				</li>
			</ul>
		</section>
	</aside>
	
	<div class="container" >
		<!-- 标签栏 -->
		<ul id="titleTab" class="nav nav-tabs"> 
			<li><a href="/org">首页</a></li>
			<li class="active"><a href="/org/seg">客运段</a></li>
			<li><a href="/org/work">车间</a></li>
			<li><a href="/org/team">班组</a></li>
		</ul>
        <!-- 查询栏 -->
        <!-- <span data-toggle="collapse" class="panel-heading" href="#search_div">高级查询栏</span>
        <div class="panel panel-default" id="search_div">
            <div class="panel-heading" >查询条件</div>
            <div class="panel-body" id="search_div_body">
                <div id="formSearch" class="form-horizontal">
                    <label class="control-label col-sm-3" style="text-align: center;">属性</label>
                    <label class="control-label col-sm-3" style="text-align: center;">运算符</label>
                    <label class="control-label col-sm-3" style="text-align: center;">值</label>
                    <label class="control-label col-sm-3" style="text-align: center;">连接符</label>
                    <br>
                    <br>
                    <div class="col-sm-3" >
                        <select class="selectpicker " id="proprity" onchange="proprityChange(this)">
                            <option value="id" selected>编号</option>
                            <option value="name">名称</option>
                             <option value="type">类型</option> 
                        </select>
                    </div>
                    <div class="col-sm-3">
                        <select class="selectpicker " id="operator">
                            <option value="like" selected>like</option>
                            <option value="<"><</option>
                            <option value=">">></option>
                            <option value="=">=</option>
                        </select>
                    </div>                  
                    <div class="col-sm-3">
                        <input type="text" class="form-control" id="value">
                    </div>
                    <div class="col-sm-3">
                        <select class="selectpicker" id="joinOperator">
                            <option value="and" selected>and</option>
                            <option value="or">or</option>
                        </select>
                    </div>
                    <br>
                    <br>
                    <textarea id="search_sqltext" class="form-control col-sm-12" rows="5" style="overflow-x: hidden;overflow-y: auto;resize: none;"></textarea>
                </div>
            </div>
            <div class="panel panel-footer" align="right" id="search_div_footer">
                <input type="button" class="btn btn-primary" name="insert" value="添加" onclick="insertSqlQuery()">
                <input type="submit" class="btn btn-success" name="submit" value="查询" onclick="queryRequest()">
            </div>
        </div>  -->
            
		<!-- 表格的工具栏 -->
		<div id="table_toolbar" class="btn-group">
			<button id="btn_addSeg" class="btn btn-default" onclick="initInsertModalFunc()">
				<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>新增
			</button>
			<button id="btn_removeSeg" class="btn btn-default" onclick="removeSegmentsFunc()">
				<span class="glyphicon glyphicon-remove" aria-hidden="true"></span>删除
			</button>
			<!-- 批处理下拉按钮 -->
			<div class="btn-group">
				<button id="btn_batch" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
					<span class="glyphicon glyphicon-import" aria-hidden="true"></span>批处理
				</button>
				<ul class="dropdown-menu" role="menu">
					<li><a href="/org/seg/download">下载格式文件</a></li>
					<li><a href="#UnloadModal" data-toggle="modal">批量上传数据</a></li>
				</ul>
			</div>
            <!-- 导出选项 -->
            <select class="form-control" onchange="exportDataTypeChange()">
                <option value="basic" selected>Export Basic</option>
                <option value="all">Export All</option>
                <option value="selected">Export Selected</option>
            </select>
		</div><!-- 表格的工具栏end -->

		<table id="table"></table>
	</div>
	

	<!-- 段信息详情模态框（Modal） -->
	<div class="modal fade" id="SegmentDetailModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">&times;</button>
					<h4 class="modal-title" id="modalTitle" name="modalTitle"></h4>
				</div> <!-- modal.header -->
				<!-- <div class="modal-body"> -->
                <div class="modal-body" id="deatailmodal_form" action="" method="get">
                    <ul>
                        <li>
                            <label>编号：</label>
                            <input type="text" class="form-control" id="deatailmodal_id" name="deatailmodal_id" />
                            <span id="id_tip"></span>
                        </li>
                        <li>
                            <label>名称：</label>
                            <input type="text" id="deatailmodal_name" name="deatailmodal_name" class="form-control" />
                            <span id="name_tip"></span>
                        </li>
                        <li>
                            <label>所属上级：</label>
                            <select id="deatailmodal_parent" class="selectpicker form-control" data-live-search="true"></select>
                            <span id="parent_tip`"></span>
                        </li>
                    </ul>
                    
                </div><!-- </div>modal-body -->
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal">取消</button>
                    <input type="button" class="btn btn-primary" id="modal_submit" name="modal_submit" value="确定">
                </div> <!-- modal-footer -->
                </div><!-- /.modal.content -->
            </div><!-- /.modal -->
        </div><!-- 段信息详情模态框（Modal）end -->
	
	<!--上传文件模态框-->
	<div class="modal fade" id="UnloadModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
					aria-hidden="true">&times;</button>
					<h4 class="modal-title" >批量上传数据</h4>
				</div> <!-- modal.header -->
				<div class="modal-body">
					<h1>Excel file upload (xls, xlsx please)</h1>
					<form action="/org/seg/unload" method=post enctype=multipart/form-data>
						<input type='file' class="btn btn-default" name='file'>
						<div class="modal-footer">
							<button class="btn btn-default" data-dismiss="modal">取消</button>
							<input type="submit" class="btn btn-primary" name="submit" value="上传">
						</div>
					</form>
				</div><!-- modal-body -->
			</div><!-- /.modal.content -->
		</div><!-- /.modal -->
	</div><!--上传文件模态框end-->

	<script src="../static/js/jquery-2.1.1.min.js"></script>
	<script src="../static/js/bootstrap.min.js"></script>
    <!-- <script src="../static/js/jquery.form.js"></script> -->
    <!-- <script src="../static/js/bootstrap-datetimepicker.js" charset="UTF-8"></script>
        <script src="../static/js/bootstrap-datetimepicker.zh-CN.js" charset="UTF-8"></script> -->
	<script src="../static/js/bootstrap-table.js"></script>
	<script src="../static/js/bootstrap-select.js"></script>
    <script src="../static/js/sidebar-menu.js"></script>
    <script src="../static/js/bootstrap-table-export.js"></script>
    <script src="../static/js/tableExport.js"></script><!-- bootstrap table本身是没有实现表格的导出的，需要扩展插件tableExport，扩展的tableExport在导出csv，txt，sql，json等格式的时候能很好的支持中文 -->

    	<script>
    		$(document).ready(function(){
    			$('#table').bootstrapTable({
    				url:'/org/seg/listAllSegment',
    				toolbar:'#table_toolbar',
					search: true, //是否显示 搜索框
					showColumns: true, //是否显示 选择显示列按钮
					pagination: true, //设置分页
					pageList: [25,50,100],
					pageSize: 25,
					idField: 'id', //重要,可设置checkbox的值为指定字段
					selectItemName: 'id', //设置checkbox name属性，可用于遍历获取选中值
					clickToSelect: true, //将在点击行时，自动选择checkbox
					striped: true, //是否显示 表格条纹
					showExport: true, //是否显示导出按钮
					exportDataType: 'basic',//FIXME:导出文件方式  支持: 'basic', 'all', 'selected'. basic：本页数据，all，获取服务器所有数据，selected,本页选择行数据
					Icon: 'glyphicon-export', //导出的图标设置
					exportOptions:{ //导出文件格式设置
						ignoreColumn: [0,5],
						fileName: '客运段信息表'+new Date().getFullYear() + (new Date().getMonth() + 1) + new Date().getDate()
					},
					columns: [{
						checkbox: true,
					}, {
						field: 'id',
						title: '编号',
						sortable: true
					}, {
						field: 'name',
						title: '名称',
						sortable: true
					}, {
						field: 'type_name',
						title: '类型',
						sortable: true,
					}, {
						field: 'parent_name',
						title: '所属路局',
						sortable: true
					}, {
						field: 'operation',
						title: '操作',
						align: 'center',
						valign: 'middle',
						formatter: function(value, row, index){
							return "<a href='#' data-toggle='modal' onclick='initEditModalFunc(\""+row.id+"\",\""+row.name+"\",\""+row.parent_name+"\")'>修改</a> " + 
							" <a href='#' onclick='removeSegmentRequest(\""+row.id+"\")' >删除</a>"
						}
					}],
				});

    		});

    		/**
    		 * 初始化新增段信息模态框
             * 第一步，初始性下拉框
             * 第二步，初始化标题和提交按钮的响应事件
             * 第三步，显示模态框 
    		 * @return 显示新增段信息模态框
    		 */
    		function initInsertModalFunc(){
    			initModalSelectFunc();
    			$("#modal_submit").click(insertSegRequest); //将提交更改按钮绑定插入操作
    			$("#modalTitle").text("新增段信息");
    			$("#SegmentDetailModal").modal("show");
    		}

    		/**
    		 * 初始化修改段信息模态框
             * 第一步，初始性下拉框
             * 第二步，初始化标题和提交按钮的响应事件
             * 第三步，显示模态框 
    		 * @return 显示修改段信息模态框
    		 */
    		function initEditModalFunc(id, name, parent_name){
    			initModalSelectFunc();
    			$('#deatailmodal_id').attr('readonly',true);
    			$('#deatailmodal_id').val(id);
    			$('#deatailmodal_name').val(name);
    			$('#deatailmodal_parent').val(parent_name);
    			$("#modal_submit").click(updateSegRequest); //将提交更改按钮绑定插入操作
    			$("#modal_submit").text("修改段信息");
    			$("#SegmentDetailModal").modal("show");
    		}

    		/**
    		 * 初始化模态框中所属路局下拉框的数据
    		 * 
    		 * 第一步，发送获得所有路局信息的请求
    		 * 第二步，select中加载数据
    		 * 
    		 * @return 模态框中所属路局下拉框
    		 */
    		function initModalSelectFunc(){
    			level = 'seg';
    			$.ajax({
    				type: "get",
    				url: "/org/listAllParent",
    				data: {level : level},
    				success: function(data,status){
    					// console.log(data);
    					$('#deatailmodal_parent').html("");
						var text ="";
						// 转换为json对象
						var dataObj=eval("("+data+")");
						for(var i in dataObj){
							// text += '<option value="' + dataObj[i].parent_id + '">' + dataObj[i].parent_name + '</option>';
							text += '<option >' + dataObj[i].parent_name + '</option>';
						}
						$("#deatailmodal_parent").html(text);
						$("#deatailmodal_parent").selectpicker('refresh');
    				}
    			});
    		}

    		/**
    		 * 删除多个段信息
    		 * 第一步，获取选中id，得到一个list
    		 * 第二步，将list转为固定格式的字符串
    		 * 第三步，发送删除请求
    		 */
    		function removeSegmentsFunc(){
    			var array = $("#table").bootstrapTable('getSelections');//返回所选的行，当没有选择任何行的时候返回一个空数组。
    			var target = "";
	            //将数组转换成字符串
	            for (var i = array.length - 1; i >= 0; i--) {
	            	target +=array[i].id;
	            	if(i > 0 )
	            		target +=",";
	            }
	            removeSegmentRequest(target);
    		}

    		/**
    		 * 发送删除段信息请求
    		 * @param  {string} target 待删除段编号组成的字符串，格式：1,2,3
    		 * @return 得到响应报文，成功--将从表中删除对应的项
    		 */
    		 function removeSegmentRequest(target){
    		 	// console.log(target);
    		 	$.ajax({
    		 		type:"post",
    		 		url:"/org/seg/remove",
    		 		data:{target_string: target},
    		 		success:function(data,status){
    		 			alert("delete ：" + data);
                    	$("#table").bootstrapTable('remove', {field: 'id', values: target.split(',')});
    		 		}
    		 	});
    		}//end of removeSegmentRequest

            /**
             * 发送插入请求
             * 第一步，获取值
             * 第二步，非空判断
             * 第三步，发送请求，根据请求值可以进行查重
             * @return {[type]} [description]
             */
    		var insertSegRequest = function insertSegmentRequest(){
    			var id = $("#deatailmodal_id").val();
				var name = $("#deatailmodal_name").val();
				var parent_name = $("#deatailmodal_parent").val();
                // console.log(id == "");
                // console.log(name == "");
                // console.log(parent_name == "");
                //只进行非空判断，查重交给input的onblur事件
                if(beforeSubmit(id, name, parent_name))
    				$.ajax({
    					type: 'get',
    					url: '/org/seg/insert',
    					data:{
    						id: id,
    						name: name,
    						parent_name: parent_name
    					},
    					success:function(data){
                            //data可能出现的值有id_error,name_error,error,success
                            list = data.split(',');
                            console.log(list);
                            for (var i = 0; i < list.length; i++) {
                                if(list[i] == 'success'){
                                    alert('insert success!!!');
                                    $("#SegmentDetailModal").modal("hide");
                                    $('#table').bootstrapTable('refresh',{url:'/org/seg/listAllSegment'});
                                }
                                else if(list[i] == 'id_error')
                                    $('#id_tip').html('此id已存在，请更换');
                                else if(list[i] == 'name_error')
                                    $('#name_tip').html('此名称已存在，请更换');
                                else if(list[i] == 'error')
                                    alert('insert failure,服务器内部错误');
                            }
    					}
    				});

    		}

    		var updateSegRequest = function updateSegmentRequest(){
    			var id = $("#deatailmodal_id").val();
				var name = $("#deatailmodal_name").val();
				var parent_name = $("#deatailmodal_parent").val();
                //只进行非空判断，查重交给input的onblur事件
                if(beforeSubmit(id, name, parent_name))
    				$.ajax({
    					type: 'get',
    					url: '/org/seg/update',
    					data:{
    						id: id,
    						name: name,
    						parent_name: parent_name
    					},
    					success:function(data){
                            //data可能出现的值有name_error,error,success
                            list = data.split(',');
                            console.log(list);
                            for (var i = 0; i < list.length; i++) {
                                if(list[i] == 'success'){
                                    alert('update success!!!');
                                    $("#SegmentDetailModal").modal("hide");
                                    $('#table').bootstrapTable('refresh',{url:'/org/seg/listAllSegment'});
                                }
                                else if(list[i] == 'name_error')
                                    $('#name_tip').html('此名称已存在，请更换');
                                else if(list[i] == 'error')
                                    alert('insert failure,服务器内部错误');
                            }
    					}
    				});
    		}

            // /**
            //  * 发送查询请求
            //  * 第一步，获得查询语句
            //  * 第二步，发送请求
            //  * 第三步，更新数据
            //  */
            // function queryRequest(){
            //     var query = $("#search_sqltext").val();
            //     if( query != ""){
            //         $.ajax({
            //             type:"post",
            //             url:"/org/seg/query", 
            //             data:{query:query},
            //             dataType:"json",
            //             success:function(data,status){
            //                 console.log(data);
            //                 $("#table").bootstrapTable('load',data);
            //             }
            //         });
            //     }
            // }

            /**
             * 发送更新/新增请求前对值进行非空判断
             * @param  {string} id          编号输入框的值
             * @param  {string} name        名称输入框的值
             * @param  {string} parent_name 所属路局下拉框的值
             * @return {boolean}            至少有一项为空就返回false
             */
            function beforeSubmit(id, name, parent_name){
                if(id == ""){
                    $('#id_tip').html('必填');
                }
                else{
                    $('#id_tip').html('');
                }
                if(name == ""){
                    $('#name_tip').html('必填');
                }
                else
                    $('#name_tip').html('');
                if(parent_name == ""){
                    $('#parent_tip').html('必填');
                }
                else
                    $('#parent_tip').html('');
                if(id == "" || name == "" || parent_name == "")
                    return false;
                else
                    return true;
            }

            // /**
            //  * 查询中属性下拉框值改变事件
            //  * @param  {HTMLElement} obj [当前的控件]
            //  * 第一步，获取选中值
            //  * 第二步，根据选中值更新运算符下拉框的值
            //  */
            // function proprityChange(obj){
            //     var selectedValue = obj.selectedOptions[0].value;//获取选中value值,因为它被泛化了，不能用bootstrap-select方法
            //     switch (selectedValue) {
            //       case 'id':
            //           setOperatorOptions(['like','<','>','=']);
            //           break;
            //       case 'name':
            //           setOperatorOptions(['like','=']);
            //           break;
            //       // case 'type':
            //       //     setOperatorOptions(['like','=']);
            //       //     break;
            //       default:
            //         // statements_def
            //         break;
            //     }
            // }

            // /**
            // * 设置运算符下拉框的选项
            // * @param {数组} array 包含所有选项的数组
            // */
            // function setOperatorOptions(array){
            //     $("#operator").html("");
            //     var text = "";
            //     for (var i  = 0; i < array.length; i++) {
            //         text += '<option value="' + array[i] + '">' + array[i] + '</option>';
            //     }
            //     $("#operator").html(text);
            //     $("#operator").selectpicker('refresh');
            // }

            // /**
            // * 添加sql查询语句
            // *
            // * 第一步，读取查询条件中控件的值
            // * 第二步，输出到textarea中
            // * @return {[type]} [description]
            // */
            // function insertSqlQuery(){
            //     var id = $("#proprity").selectpicker('val');//选中的属性值
            //     var operator = $("#operator").selectpicker('val');//选中的运算符值
            //     var value = $("#value").val();//值
            //     //TODO value的有效值判断（可以不做的）
            //     var joinOperator = $("#joinOperator").selectpicker('val');//选中的连接符
            //     var text = id + " " + operator + " '";
            //     if ( operator === 'like'){
            //         text += "%" + value + "%'";
            //     }
            //     else
            //         text += value + "'";
            //     if( $("#search_sqltext").val() != "" ){
            //         text += " " + joinOperator;
            //     } 
            //     $("#search_sqltext").val( text + " " + $("#search_sqltext").val() );
            // }

            /**
             * 导出模式下拉框 选项改变响应事件
             * 
             */
            function exportDataTypeChange(){
                console.log($('#table_toolbar').find('select').val());
                $("#table").bootstrapTable('refreshOptions',{exportDataType:$('#table_toolbar').find('select').val()});
            }

    	</script>

    	<script>
    		$.sidebarMenu($('.sidebar-menu'))
    	</script>
    </body>
    </html>